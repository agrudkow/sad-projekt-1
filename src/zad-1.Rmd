---
title: "Projekt 1"
author: "Banzekulivakha Zhan, Grudkowski Artur"
date: "18 04 2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rprojroot)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE)
```

## Zadanie 1

### Przygotowanie danych

```{r load_data}
load_data <- function(path) {
  return(read.table(path, sep = ",", header = TRUE))
}

prepare_data <- function(df) {
  # Change col names
  col_names <- c( "TICKER", "DATE", "OPEN", "HIGH", "LOW", "CLOSE", "VOL")
  colnames(df) <- col_names

  # Filter data to suit assagnment details (transactions in second half of 2019)
  df <- df[df$DATE >= 20190701 & df$DATE <= 20191231,]
  
  df <- df[order(df$DATE),]
}
```

### Dla zadanych spółek1 notowanych na WGPW, na podstawie ich notowan z drugiej połowy roku 2019 (z pliku zad1mst.zip):

### (a) wyznacz procentowe zmiany cen zamkniecia tych spółek

Zmiany procentowe są interpretowane jako zmiany zamknięcia między dwoma następującymi notowaniami w dwóch kolejnych dniach.
Wynik dla notowania *i-1* i *i* jest liczny ze wzoru: $result = (n(i - 1) - n(i)/n(i)$, gdzie *n* oznacza zbiór notowań.

```{r calc_close_diff}
calc_close_diff <- function(dataset) {
  # Init empty vector
  close_diff <- c()

  for(i in 2:nrow(dataset)) {
    first_day_val <- dataset$CLOSE[i - 1]
    second_day_val <- dataset$CLOSE[i]

    diff <- (first_day_val - second_day_val) / first_day_val
    # Convert to percentage
    diff <- diff * 100
    close_diff <- c(close_diff, diff)
  }

  return(close_diff)
}
```

Wyniki dla spółki PLAY
```{r}
# PLAY
dataset_play <- load_data("./data/p1mst/PLAY.mst") %>% prepare_data
close_diff_play <- calc_close_diff(dataset_play)

print(close_diff_play)
```

Wyniki dla spółki LPP
```{r}
# LPP
dataset_lpp <- load_data("./data/p1mst/LPP.mst") %>% prepare_data
close_diff_lpp <- calc_close_diff(dataset_lpp)

print(close_diff_lpp)
```

### (b) zilustruj rozkłady ww. zmian (histogramy + wykresy pudełkowe)

```{r draw_plots}
draw_plots <- function(data) {
  hist(data, main="Histogram rozkłądu procentowej zmiany cen zamknięcia", xlab="Zmiana procentowa", ylab="Liczność", col="darkmagenta", breaks=50)
  boxplot(data, xlab = "Percentage increase", horizontal = TRUE)
}

```

Wykres dla spółki PLAY
```{r}
draw_plots(close_diff_play)
```

Wykres dla spółi LPP
```{r}
draw_plots(close_diff_lpp)
```

### (c) wyestymuj parametry rozkładów normalnych mogacych modelowac ww. rozkłady

```{r}
estimate_dnorm_params <- function(data) {
  return(list(mean=mean(data), sd=sd(data)))
}
```

Estymacja dla spółki PLAY
```{r}
dnorm_params_play <- estimate_dnorm_params(close_diff_play)

print(dnorm_params_play$mean)
print(dnorm_params_play$sd)
```

Estymacja dla spółki LPP
```{r}
dnorm_params_lpp <- estimate_dnorm_params(close_diff_lpp)

print(dnorm_params_lpp$mean)
print(dnorm_params_lpp$sd)
```

### (d) porównaj graficznie rozkłady modelowe z danymi
```{r}
plot_comparison <- function(data, dnorm_params, col="darkmagenta") {
  hist <- hist(data, main="Histogram rozkłądu procentowej zmiany cen zamknięcia", xlab="Zmiana procentowa", ylab="Liczność", col=col, breaks=50) 
  xfit <- seq(min(data), max(data), length = 40) 
  yfit <- dnorm(xfit, mean = dnorm_params$mean, sd = dnorm_params$sd) 
  yfit <- yfit * diff(hist$mids[1:2]) * length(data) 

  lines(xfit, yfit, col = "black", lwd = 2)
}
```
Porównanie dla spółki PLAY
```{r}
plot_comparison(close_diff_play, dnorm_params_play)
```

Porównanie dla spółki LPP
```{r}
plot_comparison(close_diff_lpp, dnorm_params_lpp)
```

## Zadanie 2

### Przygotowanie danych

```{r load_data}
load_data <- function(path) {
  return(read.table(path, sep = ",", header = TRUE))
}

prepare_data <- function(df) {
  # Filter data to suit assagnment details (transactions in October 2019)
  df <- df[df$date >= 191001 & df$date <= 191031,]
  
  # Add id column
  data <- tibble::rowid_to_column(df, "id")
}
```


### Na podstawie danych z pazdziernika 2019 (z pliku zad2csv new.zip) dotyczacych zadanej spółki:

### (a) zilustruj jak wolumen transakcji rozkłada sie pomiedzy 3 fazy notowan: otwarcie3, notowania ciagłe4, zamkniecie z dogrywka

```{r}
extract_opening_transactions <- function(df) {
  # Select first opening transaction for each day
  first_opening_transactions <- df[df$time == 90000,] %>% group_by(date) %>% slice(1)

  # Select opening transaction
  opening_transactions <- data.frame(first_opening_transactions)

  # Select related transactions for each of first opening transactions
  for (i in 1:nrow(first_opening_transactions)) {
    result <- data.frame(df[df$date == first_opening_transactions$date[i] 
              & df$time == first_opening_transactions$time[i] 
              & df$price == first_opening_transactions$price[i] 
              & df$id != first_opening_transactions$id[i],]) # Skip transactions from first_opening_transactions

    opening_transactions <- rbind(opening_transactions, result)
  }

  return(opening_transactions[order(opening_transactions$id),])
}

extract_opening_transactions <- function(df, opening_transactions) {
  return(df[df$time < 165900 & !(df$id %in% opening_transactions$id),])
}

extract_opening_transactions <- function(df, opening_transactions) {
  return(df[df$time >= 165900,])
}

extract_transaction_groups <- function(df) {
  opening_transactions <- extract_opening_transactions(df)
  continous_transactions <- extract_opening_transactions(df, opening_transactions)
  closing_transactions <- extract_opening_transactions(df)

  return(list(opening=opening_transactions, continous=continous_transactions, closing=closing_transactions))
}
```

```{r}
dataset_pge <- load_data("./data/p1csv_new/PGE.csv") %>% prepare_data

transactions <- extract_transaction_groups(dataset_pge)

print(transactions$opening)
```